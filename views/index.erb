<html>

<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
  <script src="/js/socket.io.js"></script>
  <style type="text/css">
    label, span { width: 9em; }
    #count { font-size: 72pt; }
  </style>
</head>

<body>

  <div id="count"></div>

  <%#
    <embed id="a880" src="/sounds/a_880.mp3" autostart=false width=44 height=44 enablejavascript="true" />
    <embed id="a440" src="/sounds/a_440.mp3" autostart=false width=44 height=44 enablejavascript="true" />
  %>

  <p>
    <label>Client time:</label>
    <span id="clientTime"></span>
  </p>

  <p>
    <label>Average drift:</label>
    <span id="averageDrift"></span>
  </p>

  <p>
    <label>Server time:</label>
    <span id="serverTime"></span>
  </p>

  <p>
    <label>Data points:</label>
    <span id="dataPoints"></span>
  </p>

  <p>
    <label>Standard deviation:</label>
    <span id="stdev"></span>
  </p>

  <script>
    var FixedSizeQueue = {
      create: function(size) {
        var obj = {
          size:   100,
          queue:  [],

          create: function(size) {
            obj.size = size;
            return obj;
          },

          enqueue: function(item) {
            while (obj.queue.length + 1 > obj.size)
            {
              obj.queue.shift();
            }
            obj.queue.push(item);
          },

          asArray: function() {
            return obj.queue;
          }
        };

        return obj.create(size);
      }
    };
    var getTimer = function() {
      var obj = {
        samples:   FixedSizeQueue.create(100),
        websocket: null,

        // Public methods
        getAverageDrift: function()
        {
          if (obj.samples.asArray().length < 1) return 0;
          if (obj.samples.asArray().length == 1) return obj.samples.asArray().slice(0, 1);
          var totalDrift = obj.samples.asArray().reduce(function(a, b) { return a + b; });
          return totalDrift / obj.samples.asArray().length;
        },

        getStandardDeviationOfDrift: function()
        {
          var asArray = obj.samples.asArray();
          if (asArray.length < 2) return 0;
          var avg                   = obj.getAverageDrift();
          var distancesSquared      = asArray.map(function(a) { return Math.pow(avg - a, 2); });
          var sumOfDistancesSquared = distancesSquared.reduce(function(a, b) { return a + b; });
          var standardDeviation     = Math.sqrt(sumOfDistancesSquared / asArray.length);
          return standardDeviation;
        },

        getNumSamples: function()
        {
          return obj.samples.asArray().length;
        },

        // Private methods
        _setup: function()
        {
          // Set up timer
          function updateDrift()
          {
            $.ajax({
              url: '/time',
              success: function(data) {
                var serverTime = parseFloat(data);
                if (!serverTime) return;
                var clientTime = (new Date).getTime();
                var drift      = clientTime - serverTime;
                obj.samples.enqueue(drift);

                setTimeout(updateDrift, 300);
              }
            });
          }
          updateDrift();

          return obj;
        }
      };

      return obj._setup();
    };

    function setUpMetronome()
    {
      var timer    = getTimer();

      setInterval(function () {
        var clientTime   = (new Date).getTime();
        var averageDrift = timer.getAverageDrift();
        var serverTime   = clientTime - averageDrift;
        var stdev        = timer.getStandardDeviationOfDrift();
        $('#clientTime').html(clientTime + '');
        $('#averageDrift').html(averageDrift + '');
        $('#serverTime').html(serverTime + '');
        $('#dataPoints').html(timer.getNumSamples() + '');
        $('#stdev').html(stdev + '');

        // If we're the first half of the second, background black, otherwise white
        // var a880 = document.getElementById('a880');
        // var a440 = document.getElementById('a440');
        var part = serverTime % 2000;
        if (part < 500)
        {
          $('body').css('background-color', '#fff');
          $('#count').html('1');
          // a880.Play();                              // Beat 1
        } else if (part >= 500 && part < 1000) {
          $('body').css('background-color', '#aaa');
          $('#count').html('2');
          // a440.Play();                              // Beat 2
        } else if (part >= 1000 && part < 1500) {
          $('body').css('background-color', '#c7c7c7');
          $('#count').html('3');
          // a440.Play();                              // Beat 3
        } else if (part >= 1500) {
          $('body').css('background-color', '#aaa');
          $('#count').html('4');
          // a440.Play();                              // Beat 4
        }
      }, 17);
    }

    // Orchestrate all this stuff on page load
    $(document).ready(function() {
      setUpMetronome();
    });
  </script>
</body>

</html>

